<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="pouchdb.html">
<link rel="import" href="pouchdb-behavior.html">

<!--
`pouchdb-document` provides a simple interface for working with PouchDB
documents in a Polymer app.

Example:

    <pouchdb-document db-name="mydb" doc-id="dino-1" data="{{dinosaur}}">

In this example, if the `dinosaur` object is data-bound elsewhere via Polymer's
data-binding system, changes to the document will be automatically reflected in
the remote document and any other clients referencing that document.
-->

<script>
  Polymer({
    is: 'pouchdb-document',

    behaviors: [Polymer.PouchdbBehavior],

    properties: {
      /**
       * The id of the corresponding document.
       */
      docId: {
        type: String,
        notify: true
      },

      /**
       * The `data` object for the corresponding document.
       */
      data: {
        type: Object,
        notify: true
      },

      _receivingDbChanges: {
        type: Boolean,
        value: false
      },

      _puttingDbChanges: {
        type: Boolean,
        value: false
      }
    },

    listeners: {
      'pouchdb-update': '_onUpdate'
    },

    observers: [
      '_docIdChanged(db, docId)',
      '_dataChanged(db, data.*)'
    ],

    _updateFromDb: function(data) {
      this._receivingDbChanges = true;
      this.set('data', data);
      this._receivingDbChanges = false;
    },

    _docIdChanged: function(db, docId) {
      db.get(docId).then(function(data) {
        this._updateFromDb(data);
      }.bind(this));
    },

    _dataChanged: function() {
      if (!this._receivingDbChanges && !this._puttingDbChanges) {
        this._puttingDbChanges = true;
        this.db.put(this.data).then(function(result) {
          this.set('data._rev', result.rev);
          this._puttingDbChanges = false;
        }.bind(this));
      }
    },

    _onUpdate: function(info) {
      if (info.id === this.docId) {
        this._updateFromDb(info.data);
      }
    },

    _getChangeOpts: function(changeOpts) {
      if (this.docId) {
        /* jshint camelcase: false */
        changeOpts.doc_ids = [this.docId];
      }
      return changeOpts;
    },

  });
</script>
